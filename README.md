# nuwa
My personal homelab setup config, using terraform and ansible

## Infrastructure
The infrastructure is managed by Terraform, virtual machines will be created after applying the plan.

## Terraform
Using terraform to easily setup and destroy the vms on my xenserver. The provider I will use is xen xenorchestra.

## Ansible
The service setup will be done by Ansible

### Virtual Machines

- 3 k3s worker vm on sata storage
- 3 k3s longhorn node vm on nvme storage
- 3 k3s master vm on nvme storage
- 1 low cpu large storage for arch mirror

### Resource Definition

```hcl
variable "k3s_worker_cluster_resources" {
  default = {
    memory_max = 8 * 1024 * 1024 * 1024 # 8gb
    disk_size = 50 * 1024 * 1024 * 1024 # 50gb
    size = 3
    cpus = 4
    mac_pool = {
      start = 3
      end = 6
    }
  }
}

```
#### Mac Pool
Due to the xenorchestra plugin issue dealing with mac address generated by the provider, pre generated macs are defined in `var.vm_macs`, in each resource definition we will use `mac_pool` to allocate the mac address used by the vm

### XOA Settings
XOA settings needs to be defined in files so it can be loaded by terraform during planning

### Ansible Inventory
After the VM is provisioned, the ansible inventory file will be generated under `inventory/hosts.ini`

#### On Linux

##### xoa.sh
```bash
#!/bin/sh

export XOA_URL=wss://xoa.host.com
export XOA_USER=admin@admin.net
export XOA_PASSWORD=admin

# Change the contents of this output to get the environment variables
# of interest. The output must be valid JSON, with strings for both
# keys and values.
cat <<EOF
{
  "XOA_URL": "$XOA_URL",
  "XOA_USER": "$XOA_USER"
  "XOA_PASSWORD": "$XOA_PASSWORD"
}
EOF
```

#### On Windows

##### xoa.ps1
```powershell
$Env:XOA_URL = "wss://xoa.host.com"
$Env:XOA_USER = "admin@admin.net"
$Env:XOA_PASSWORD = "admin"

ConvertTo-Json @{
    XOA_URL = $Env:XOA_URL
    XOA_USER = $Env:XOA_USER
    XOA_PASSWORD = $Env:XOA_PASSWORD
}
```
